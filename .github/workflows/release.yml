name: Docker Publish

on:
  #目前是手动发版
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup
        uses: actions/setup-go@v3
        with:
          go-version-file: "go.mod"

      - name: Build
        run: make release

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          draft: true
          generate_release_notes: true
          body: |
            * 这是 GitHub Actions 自动化部署，更新日志应该很快会手动更新

  docker:
    runs-on: ubuntu-latest
    steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up QEMU (for multi-arch builds)
          uses: docker/setup-qemu-action@v2

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3

        - name: Log in to GitHub Container Registry
          uses: docker/login-action@v2
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

        - name: Build and push Docker image
          uses: docker/build-push-action@v5
          with:
            context: .
            push: true
            tags: |
              ghcr.io/${{ github.repository_owner }}/my-go-project:latest
              ghcr.io/${{ github.repository_owner }}/my-go-project:${{ github.sha }}
            platforms: linux/amd64,linux/arm64
